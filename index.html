<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>MerakiAPP - Gestor de Gastos</title>

<style>
/* --- AMOLED STYLE OPTIMIZADO --- */

@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@600;800&display=swap');

/* Fondo general */
body {
  background: #000;
  color: #fff;
  margin: 0;
  padding: 0;
  font-family: 'Poppins', sans-serif;
  overflow-x: hidden;
}

/* Header y t√≠tulo */
#appTitle {
  text-align: center;
  font-size: 28px;
  margin: 15px 0 5px;
  font-weight: 900;
  letter-spacing: 1.5px;
  background: linear-gradient(120deg, #00FFFF, #9b00ff, #00FFFF);
  background-size: 200% 200%;
  animation: titleGlow 5s ease infinite;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  padding: 0 10px;
}

@keyframes titleGlow {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* Tabs mejorados */
.tabs {
  display: flex;
  justify-content: space-around;
  background: #090909;
  border-bottom: 1px solid #222;
  position: sticky;
  top: 0;
  z-index: 100;
}

.tab {
  flex: 1;
  padding: 14px 5px;
  text-align: center;
  cursor: pointer;
  font-size: 15px;
  color: #aaa;
  transition: all 0.3s;
  border-bottom: 3px solid transparent;
}

.tab.active {
  color: #fff;
  border-bottom: 3px solid #0066FF;
  background: linear-gradient(to bottom, rgba(0,102,255,0.1), transparent);
}

/* Vistas optimizadas */
.view {
  display: none;
  padding: 15px;
  animation: fadeIn 0.3s ease;
  max-width: 600px;
  margin: 0 auto;
}

.view.active {
  display: block;
}

/* SECCI√ìN HOME - Reorganizada */

/* Saldos en tarjetas */
.saldos-container {
  display: flex;
  gap: 10px;
  margin: 15px 0;
}

.saldo-card {
  flex: 1;
  background: #0b0b0b;
  border: 1px solid #222;
  border-radius: 14px;
  padding: 15px;
  text-align: center;
}

.saldo-label {
  font-size: 14px;
  color: #aaa;
  margin-bottom: 5px;
}

.saldo-valor {
  font-size: 22px;
  font-weight: 800;
  color: #00FFFF;
}

/* Acciones principales */
.acciones-principales {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin: 20px 0;
}

.btn-primary {
  background: linear-gradient(120deg, #0066FF, #AA00FF);
  padding: 16px;
  border-radius: 14px;
  border: none;
  color: white;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s, opacity 0.2s;
}

.btn-primary:hover {
  transform: scale(1.02);
  opacity: 0.95;
}

.btn-secondary {
  background: #222;
  padding: 14px;
  border-radius: 12px;
  border: none;
  color: white;
  font-size: 15px;
  cursor: pointer;
  transition: background 0.2s;
}

.btn-secondary:hover {
  background: #333;
}

.btn-danger {
  background: linear-gradient(120deg, #ff3333, #990000);
  padding: 14px;
  border-radius: 12px;
  border: none;
  color: white;
  font-size: 15px;
  cursor: pointer;
  margin-top: 10px;
}

/* Formulario agregar presupuesto */
.form-presupuesto {
  background: #0b0b0b;
  border: 1px solid #222;
  border-radius: 16px;
  padding: 15px;
  margin: 15px 0;
}

.form-presupuesto h3 {
  margin-top: 0;
  color: #aaa;
}

.input-group {
  margin-bottom: 12px;
}

.input-group label {
  display: block;
  margin-bottom: 5px;
  color: #ccc;
  font-size: 14px;
}

.input-group input,
.input-group select,
.input-group textarea {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid #333;
  background: #000;
  color: white;
  font-size: 15px;
  box-sizing: border-box;
}

/* Secci√≥n administraci√≥n */
.seccion-admin {
  margin-top: 25px;
  padding-top: 15px;
  border-top: 1px solid #222;
}

.seccion-admin h3 {
  color: #aaa;
  margin-bottom: 10px;
}

/* SECCI√ìN GASTOS */
.productos-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 10px;
  margin: 15px 0;
}

.producto-card {
  background: #0d0d0d;
  padding: 12px;
  border-radius: 14px;
  text-align: center;
  border: 1px solid #222;
  cursor: pointer;
  transition: all 0.2s;
}

.producto-card:hover {
  transform: scale(1.03);
  border-color: #555;
}

.card-actions {
  margin-top: 8px;
  display: flex;
  justify-content: space-between;
}

.btn-mini {
  background: #222;
  padding: 6px 10px;
  border-radius: 8px;
  font-size: 12px;
  border: none;
  color: white;
  cursor: pointer;
}

/* SECCI√ìN REGISTRO */
.acciones-registro {
  display: flex;
  gap: 10px;
  margin: 15px 0;
}

#listaRegistro {
  margin-top: 15px;
}

.item {
  background: #0b0b0b;
  border: 1px solid #222;
  padding: 12px;
  border-radius: 12px;
  margin-top: 8px;
  font-size: 14px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.delete-btn {
  background: #222;
  border: 1px solid #333;
  color: #fff;
  padding: 6px 12px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 12px;
}

/* Animaciones */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Responsive */
@media (max-width: 480px) {
  .saldos-container {
    flex-direction: column;
  }
  
  .productos-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .acciones-registro {
    flex-direction: column;
  }
}

/* Quita el resaltado azul feo al tocar */
* {
  -webkit-tap-highlight-color: transparent;
}
</style>
</head>

<body>
  <h1 id="appTitle">MerakiAPP</h1>

  <div class="tabs">
    <div class="tab active" data-target="home">üè† Inicio</div>
    <div class="tab" data-target="gastos">üí∞ Gastos</div>
    <div class="tab" data-target="registro">üìã Registro</div>
  </div>

  <!-- PESTA√ëA INICIO - Reorganizada -->
  <div class="view active" id="home">
    <!-- Saldos visibles -->
    <div class="saldos-container">
      <div class="saldo-card">
        <div class="saldo-label">Total</div>
        <div class="saldo-valor" id="totalPresupuesto">0</div>
      </div>
      <div class="saldo-card">
        <div class="saldo-label">Efectivo</div>
        <div class="saldo-valor" id="efectivoPresupuesto">0</div>
      </div>
      <div class="saldo-card">
        <div class="saldo-label">Yape</div>
        <div class="saldo-valor" id="yapePresupuesto">0</div>
      </div>
    </div>

    <!-- ACCIONES PRINCIPALES (arriba, f√°cil acceso) -->
    <div class="acciones-principales">
      <button class="btn-primary" id="btnAgregarPresupuesto">
        ‚ûï Agregar Presupuesto
      </button>
      <button class="btn-secondary" id="btnBorrarGastos">
        üóëÔ∏è Borrar TODOS los gastos
      </button>
    </div>

    <!-- Formulario para agregar presupuesto (inicialmente oculto) -->
    <div class="form-presupuesto" id="formAgregarPresupuesto" style="display: none;">
      <h3>Agregar presupuesto</h3>
      <div class="input-group">
        <label>Monto a agregar</label>
        <input type="number" id="montoAgregar" placeholder="Ej: 100" />
      </div>
      
      <div class="input-group">
        <label>Tipo</label>
        <select id="tipoMonto">
          <option value="efectivo">Efectivo</option>
          <option value="yape">Yape</option>
          <option value="general">General</option>
        </select>
      </div>
      
      <div class="input-group">
        <label>Nota (opcional)</label>
        <textarea id="notaPresupuesto" placeholder="Ej: Pago del trabajo" rows="2"></textarea>
      </div>
      
      <button class="btn-primary" id="btnConfirmarAgregar">Confirmar</button>
      <button class="btn-secondary" id="btnCancelarAgregar">Cancelar</button>
    </div>

    <!-- Secci√≥n Administraci√≥n (m√°s abajo, menos accesible) -->
    <div class="seccion-admin">
      <h3>Administraci√≥n</h3>
      <button class="btn-danger" id="btnBorrarRegistro">
        üóëÔ∏è Borrar TODO el registro
      </button>
      <button class="btn-danger" id="btnBorrarTodosGastos">
        üî• Borrar TODOS los gastos
      </button>
      <button class="btn-danger" id="btnResetPresupuesto">
        üîÑ Restablecer presupuesto
      </button>
    </div>
  </div>

  <!-- PESTA√ëA GASTOS -->
  <div class="view" id="gastos">
    <h2>Registrar gasto</h2>

    <h3>Productos frecuentes</h3>
    <div id="productosFrecuentes" class="productos-grid"></div>

    <div class="acciones-principales">
      <button class="btn-primary" id="btnNuevoProducto">‚ûï Agregar nuevo producto</button>
      <button class="btn-secondary" id="btnOtroProducto">üìù Otro producto</button>
    </div>

    <!-- Inputs manuales para gastos -->
    <div id="inputsManual" style="display:none; margin-top:20px;">
      <div class="form-presupuesto">
        <div class="input-group">
          <label>Nombre del producto</label>
          <input type="text" id="gastoNombre" placeholder="Ej: Caf√©" />
        </div>
        
        <div class="input-group">
          <label>Precio</label>
          <input type="number" id="gastoPrecio" placeholder="Ej: 12.50" />
        </div>
        
        <div class="input-group">
          <label>M√©todo de pago</label>
          <select id="metodoPago">
            <option value="efectivo">Efectivo</option>
            <option value="yape">Yape</option>
            <option value="general">General</option>
          </select>
        </div>
        
        <button class="btn-primary" id="btnGuardarGasto">üíæ Guardar gasto</button>
        <button class="btn-secondary" id="btnCancelarGasto">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- PESTA√ëA REGISTRO -->
  <div class="view" id="registro">
    <h2>üìã Registro de eventos</h2>
    
    <!-- Acciones espec√≠ficas del registro -->
    <div class="acciones-registro">
      <button class="btn-primary" id="copiarResumenBtn">üìã Copiar resumen del D√çA</button>
      <!-- Bot√≥n Exportar ELIMINADO como pediste -->
    </div>
    
    <div id="listaRegistro"></div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
import {
  getFirestore, doc, getDoc, updateDoc, setDoc,
  addDoc, collection, deleteDoc, onSnapshot,
  getDocs, writeBatch, query, where
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC495_-26LNEAISFd0uB-2wSDGZd-EY_Qc",
  authDomain: "datosmeraki-d4a4d.firebaseapp.com",
  projectId: "datosmeraki-d4a4d",
  storageBucket: "datosmeraki-d4a4d.firebasestorage.app",
  messagingSenderId: "813586255966",
  appId: "1:813586255966:web:78acf1f1cfa1f1b4a164cf",
  measurementId: "G-HXBGQGJCJE"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const presupuestoRef = doc(db, "Presupuesto", "actual");

/* ================= NAVEGACI√ìN ENTRE PESTA√ëAS ================= */
document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    document.querySelector(".tab.active").classList.remove("active");
    tab.classList.add("active");
    document.querySelector(".view.active").classList.remove("active");
    document.getElementById(tab.dataset.target).classList.add("active");
  });
});

/* ================ GESTI√ìN DEL FORMULARIO AGREGAR PRESUPUESTO ================ */
document.getElementById("btnAgregarPresupuesto").addEventListener("click", () => {
  document.getElementById("formAgregarPresupuesto").style.display = "block";
});

document.getElementById("btnCancelarAgregar").addEventListener("click", () => {
  document.getElementById("formAgregarPresupuesto").style.display = "none";
  document.getElementById("montoAgregar").value = "";
  document.getElementById("notaPresupuesto").value = "";
});

/* ================ INICIALIZAR PRESUPUESTO ================ */
async function ensurePresupuesto() {
  const snap = await getDoc(presupuestoRef);
  if (!snap.exists()) {
    await setDoc(presupuestoRef, {
      total: 0,
      efectivo: 0,
      yape: 0,
      notas: ""
    });
  }
}
ensurePresupuesto();

/* ================ ACTUALIZAR SALDOS EN TIEMPO REAL ================ */
onSnapshot(presupuestoRef, snap => {
  if (!snap.exists()) return;
  const d = snap.data();
  document.getElementById("totalPresupuesto").textContent = d.total?.toFixed(2) || "0.00";
  document.getElementById("efectivoPresupuesto").textContent = d.efectivo?.toFixed(2) || "0.00";
  document.getElementById("yapePresupuesto").textContent = d.yape?.toFixed(2) || "0.00";
});

/* ================ AGREGAR PRESUPUESTO - CORREGIDO PARA "GENERAL" ================ */
document.getElementById("btnConfirmarAgregar").addEventListener("click", async () => {
  const monto = Number(document.getElementById("montoAgregar").value);
  const tipo = document.getElementById("tipoMonto").value;
  const nota = document.getElementById("notaPresupuesto").value || "";

  if (!monto || monto <= 0) {
    alert("Por favor ingresa un monto v√°lido");
    return;
  }

  const snap = await getDoc(presupuestoRef);
  const data = snap.data();

  const nuevoTotal = (data.total || 0) + monto;
  let nuevoEfectivo = data.efectivo || 0;
  let nuevoYape = data.yape || 0;

  // CORRECCI√ìN: Si es "general", se distribuye entre efectivo y yape
  if (tipo === "efectivo") {
    nuevoEfectivo += monto;
  } else if (tipo === "yape") {
    nuevoYape += monto;
  } else if (tipo === "general") {
    // Dividir el monto entre efectivo y yape (50% cada uno)
    const mitad = monto / 2;
    nuevoEfectivo += mitad;
    nuevoYape += mitad;
  }

  await updateDoc(presupuestoRef, {
    total: nuevoTotal,
    efectivo: nuevoEfectivo,
    yape: nuevoYape,
    notas: nota
  });

  // Registrar evento
  await addDoc(collection(db, "Registro"), {
    mensaje: `‚úÖ Agregaste S/ ${monto.toFixed(2)} a ${tipo === "general" ? "General (distribuido en efectivo y yape)" : tipo}` + (nota ? ` (${nota})` : ""),
    fecha: new Date(),
    tipo: "presupuesto_agregado"
  });

  // Limpiar y ocultar formulario
  document.getElementById("montoAgregar").value = "";
  document.getElementById("notaPresupuesto").value = "";
  document.getElementById("formAgregarPresupuesto").style.display = "none";
  
  alert(`‚úÖ Presupuesto actualizado! +S/ ${monto.toFixed(2)}`);
});

/* ================ PRODUCTOS FRECUENTES ================ */
const productosRef = collection(db, "Productos");
const contenedor = document.getElementById("productosFrecuentes");
const inputsManual = document.getElementById("inputsManual");

// Mostrar/ocultar inputs manuales
document.getElementById("btnOtroProducto").addEventListener("click", () => {
  inputsManual.style.display = "block";
  document.getElementById("gastoNombre").value = "";
  document.getElementById("gastoPrecio").value = "";
});

document.getElementById("btnCancelarGasto").addEventListener("click", () => {
  inputsManual.style.display = "none";
  document.getElementById("gastoNombre").value = "";
  document.getElementById("gastoPrecio").value = "";
});

// Cargar productos
onSnapshot(productosRef, snap => {
  contenedor.innerHTML = "";

  snap.forEach(docu => {
    const p = docu.data();
    const card = document.createElement("div");
    card.className = "producto-card";
    card.innerHTML = `
      <div style="font-size:16px; font-weight:600;">${p.nombre}</div>
      <div class="card-actions">
        <button class="btn-mini" data-editar="${docu.id}">‚úèÔ∏è</button>
        <button class="btn-mini" data-borrar="${docu.id}">üóëÔ∏è</button>
      </div>
    `;

    // Seleccionar producto para gasto
    card.addEventListener("click", (e) => {
      if (e.target.tagName === 'BUTTON') return;
      inputsManual.style.display = "block";
      document.getElementById("gastoNombre").value = p.nombre;
      document.getElementById("gastoPrecio").value = "";
      document.getElementById("gastoPrecio").focus();
    });

    contenedor.appendChild(card);
  });

  // Botones de borrar
  document.querySelectorAll("[data-borrar]").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      e.stopPropagation();
      if (confirm("¬øBorrar este producto?")) {
        await deleteDoc(doc(db, "Productos", btn.dataset.borrar));
      }
    });
  });

  // Botones de editar
  document.querySelectorAll("[data-editar]").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      e.stopPropagation();
      const nuevoNombre = prompt("Nuevo nombre del producto:");
      if (nuevoNombre && nuevoNombre.trim()) {
        await updateDoc(doc(db, "Productos", btn.dataset.editar), { 
          nombre: nuevoNombre.trim() 
        });
      }
    });
  });
});

// Agregar nuevo producto
document.getElementById("btnNuevoProducto").addEventListener("click", async () => {
  const nombre = prompt("Nombre del nuevo producto:");
  if (nombre && nombre.trim()) {
    await addDoc(productosRef, { nombre: nombre.trim() });
  }
});

/* ================ GUARDAR GASTO - CORREGIDO PARA "GENERAL" ================ */
document.getElementById("btnGuardarGasto").addEventListener("click", async () => {
  const nombre = document.getElementById("gastoNombre").value.trim();
  const precio = Number(document.getElementById("gastoPrecio").value);
  const metodo = document.getElementById("metodoPago").value;

  if (!nombre || !precio || precio <= 0) {
    alert("Por favor completa todos los campos correctamente");
    return;
  }

  // Verificar saldo
  const snap = await getDoc(presupuestoRef);
  if (!snap.exists()) return alert("Error al obtener presupuesto");

  const data = snap.data();
  const saldoMetodo = metodo === "efectivo" ? data.efectivo 
                     : metodo === "yape" ? data.yape 
                     : data.total; // Para "general" usa el total

  if (saldoMetodo < precio) {
    alert(`‚ùå Saldo insuficiente en ${metodo}. Disponible: S/ ${saldoMetodo.toFixed(2)}`);
    return;
  }

  // Actualizar presupuesto
  const nuevoTotal = (data.total || 0) - precio;
  let nuevoEfectivo = data.efectivo || 0;
  let nuevoYape = data.yape || 0;

  if (metodo === "efectivo") {
    nuevoEfectivo -= precio;
  } else if (metodo === "yape") {
    nuevoYape -= precio;
  } else if (metodo === "general") {
    // Para "general", restar mitad de cada uno
    const mitad = precio / 2;
    nuevoEfectivo -= mitad;
    nuevoYape -= mitad;
  }

  await updateDoc(presupuestoRef, {
    total: nuevoTotal,
    efectivo: nuevoEfectivo,
    yape: nuevoYape
  });

  // Guardar gasto
  await addDoc(collection(db, "Gastos"), {
    nombre,
    precio,
    metodo,
    fecha: new Date()
  });

  // Registrar evento
  await addDoc(collection(db, "Registro"), {
    mensaje: `üõí Gastaste S/ ${precio.toFixed(2)} en ${nombre} (${metodo})`,
    fecha: new Date(),
    tipo: "gasto_registrado"
  });

  // Limpiar y ocultar
  document.getElementById("gastoNombre").value = "";
  document.getElementById("gastoPrecio").value = "";
  inputsManual.style.display = "none";
  
  alert(`‚úÖ Gasto registrado! -S/ ${precio.toFixed(2)}`);
});

/* ================ BORRAR REGISTRO ================ */
document.getElementById("btnBorrarRegistro").addEventListener("click", async () => {
  if (!confirm("‚ö†Ô∏è ¬øEST√ÅS 100% SEGURO? Esto borrar√° PERMANENTEMENTE TODO el registro de eventos.")) return;
  
  try {
    const btn = document.getElementById("btnBorrarRegistro");
    const originalText = btn.textContent;
    btn.textContent = "üîÑ Borrando...";
    btn.disabled = true;
    
    const registroRef = collection(db, "Registro");
    const snapshot = await getDocs(registroRef);
    
    if (snapshot.empty) {
      alert("‚úÖ El registro ya est√° vac√≠o");
      btn.textContent = originalText;
      btn.disabled = false;
      return;
    }
    
    console.log(`üìä Documentos a borrar: ${snapshot.size}`);
    
    const batch = writeBatch(db);
    let contador = 0;
    
    snapshot.forEach((docu) => {
      batch.delete(docu.ref);
      contador++;
    });
    
    await batch.commit();
    
    console.log(`‚úÖ Borrados ${contador} documentos de Firestore`);
    
    const cont = document.getElementById("listaRegistro");
    cont.innerHTML = '<div class="item" style="text-align: center; color: #aaa; padding: 20px;">üì≠ Registro vac√≠o</div>';
    
    await addDoc(collection(db, "Registro"), {
      mensaje: "üßπ Registro limpiado completamente por el usuario",
      fecha: new Date(),
      tipo: "admin_limpieza"
    });
    
    alert(`‚úÖ ¬°BORRADO EXITOSO!\nSe eliminaron ${contador} registros de Firestore.`);
    
  } catch (error) {
    console.error("‚ùå Error cr√≠tico al borrar registro:", error);
    alert(`‚ùå ERROR: No se pudo borrar el registro.\n\nDetalles: ${error.message}`);
  } finally {
    const btn = document.getElementById("btnBorrarRegistro");
    btn.textContent = "üóëÔ∏è Borrar TODO el registro";
    btn.disabled = false;
  }
});

/* ================ BORRAR TODOS LOS GASTOS ================ */
document.getElementById("btnBorrarTodosGastos").addEventListener("click", async () => {
  if (!confirm("‚ö†Ô∏è ¬øBORRAR TODOS LOS GASTOS PERMANENTEMENTE?\n\nEsto incluye todos los meses y a√±os.\nSe perder√°n todos los datos hist√≥ricos de gastos.")) return;
  
  try {
    const btn = document.getElementById("btnBorrarTodosGastos");
    const originalText = btn.textContent;
    btn.textContent = "üî• Borrando...";
    btn.disabled = true;
    
    const gastosRef = collection(db, "Gastos");
    const snapshot = await getDocs(gastosRef);
    
    if (snapshot.empty) {
      alert("‚úÖ No hay gastos para borrar");
      btn.textContent = originalText;
      btn.disabled = false;
      return;
    }
    
    console.log(`üìä Gastos a borrar: ${snapshot.size}`);
    
    const batch = writeBatch(db);
    let contador = 0;
    
    snapshot.forEach((docu) => {
      batch.delete(docu.ref);
      contador++;
    });
    
    await batch.commit();
    
    console.log(`‚úÖ Borrados ${contador} gastos de Firestore`);
    
    await addDoc(collection(db, "Registro"), {
      mensaje: `üî• Se borraron TODOS los gastos (${contador} registros)`,
      fecha: new Date(),
      tipo: "admin_limpieza_total"
    });
    
    alert(`‚úÖ ¬°TODOS LOS GASTOS BORRADOS!\nSe eliminaron ${contador} gastos de Firestore.\n\nAhora el resumen diario estar√° vac√≠o.`);
    
  } catch (error) {
    console.error("Error al borrar gastos:", error);
    alert("‚ùå Error: " + error.message);
  } finally {
    const btn = document.getElementById("btnBorrarTodosGastos");
    btn.textContent = "üî• Borrar TODOS los gastos";
    btn.disabled = false;
  }
});

/* ================ BORRAR GASTOS ================ */
document.getElementById("btnBorrarGastos").addEventListener("click", async () => {
  if (!confirm("‚ö†Ô∏è ¬øBorrar TODOS los gastos del sistema?")) return;

  const gastosRef = collection(db, "Gastos");
  const snap = await getDocs(gastosRef);
  const batch = writeBatch(db);
  
  snap.forEach(docu => batch.delete(docu.ref));
  await batch.commit();

  await addDoc(collection(db, "Registro"), {
    mensaje: "üßπ Se borraron TODOS los gastos",
    fecha: new Date(),
    tipo: "admin"
  });
  
  alert("‚úÖ Todos los gastos han sido eliminados de Firestore");
});

/* ================ RESTABLECER PRESUPUESTO ================ */
document.getElementById("btnResetPresupuesto").addEventListener("click", async () => {
  if (!confirm("‚ö†Ô∏è ¬øRestablecer presupuesto a cero? Esta acci√≥n no se puede deshacer.")) return;

  await updateDoc(presupuestoRef, {
    total: 0,
    efectivo: 0,
    yape: 0,
    notas: ""
  });

  await addDoc(collection(db, "Registro"), {
    mensaje: "üîÑ Presupuesto restablecido a cero",
    fecha: new Date(),
    tipo: "admin"
  });
  
  alert("‚úÖ Presupuesto restablecido a S/ 0.00 en Firestore");
});

/* ================ REGISTRO EN TIEMPO REAL ================ */
onSnapshot(collection(db, "Registro"), snap => {
  const cont = document.getElementById("listaRegistro");
  
  if (snap.empty) {
    cont.innerHTML = '<div class="item" style="text-align: center; color: #aaa; padding: 20px;">üì≠ Registro vac√≠o</div>';
    return;
  }
  
  cont.innerHTML = "";
  const registros = [];
  
  snap.forEach(docu => {
    registros.push({ id: docu.id, ...docu.data() });
  });
  
  registros.sort((a, b) => {
    const fechaA = a.fecha?.toDate ? a.fecha.toDate() : new Date(a.fecha || 0);
    const fechaB = b.fecha?.toDate ? b.fecha.toDate() : new Date(b.fecha || 0);
    return fechaB - fechaA;
  });
  
  registros.forEach(d => {
    const div = document.createElement("div");
    div.className = "item";
    
    const fecha = d.fecha?.toDate ? d.fecha.toDate() : new Date(d.fecha || 0);
    const fechaStr = fecha.toLocaleString();
    
    div.innerHTML = `
      <div>
        <div style="font-size: 13px; color: #aaa;">${fechaStr}</div>
        <div>${d.mensaje || "Sin mensaje"}</div>
      </div>
    `;
    cont.appendChild(div);
  });
});

/* ================ COPIAR RESUMEN DEL D√çA - FUNCI√ìN MODIFICADA ================ */
document.getElementById("copiarResumenBtn").addEventListener("click", async () => {
  try {
    const btn = document.getElementById("copiarResumenBtn");
    const originalText = btn.textContent;
    btn.textContent = "üîÑ Generando...";
    btn.disabled = true;
    
    const hoy = new Date();
    const dia = hoy.getDate();
    const month = hoy.getMonth() + 1;
    const year = hoy.getFullYear();
    const fechaHoyStr = hoy.toLocaleDateString();
    
    const q = await getDocs(collection(db, "Gastos"));
    let total = 0;
    let lista = "";
    let conteo = 0;
    const gastosHoy = [];
    
    q.forEach(doc => {
      const data = doc.data();
      let fecha;
      
      if (data.fecha && data.fecha.toDate) {
        fecha = data.fecha.toDate();
      } else if (data.fecha && data.fecha.seconds) {
        fecha = new Date(data.fecha.seconds * 1000);
      } else if (data.fecha) {
        fecha = new Date(data.fecha);
      } else {
        fecha = new Date();
      }
      
      // Filtrar por D√çA ACTUAL (no mes completo)
      if (fecha.getDate() === dia && 
          fecha.getMonth() + 1 === month && 
          fecha.getFullYear() === year) {
        const precio = parseFloat(data.precio || 0);
        total += precio;
        conteo++;
        gastosHoy.push({
          nombre: data.nombre || "Sin nombre",
          precio: precio,
          metodo: data.metodo || "general",
          fecha: fecha
        });
      }
    });
    
    gastosHoy.sort((a, b) => b.fecha - a.fecha);
    
    gastosHoy.forEach(gasto => {
      const horaStr = gasto.fecha.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      lista += `‚Ä¢ ${gasto.nombre}: S/ ${gasto.precio.toFixed(2)} (${gasto.metodo}) - ${horaStr}\n`;
    });
    
    const resumen = 
`üìä RESUMEN DEL D√çA - MerakiAPP
üìÖ Fecha: ${fechaHoyStr}
‚è∞ Generado: ${hoy.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}

üí∞ Total gastado hoy: S/ ${total.toFixed(2)}
üî¢ Cantidad de gastos: ${conteo}

${conteo > 0 ? 'üõí Gastos de hoy:\n' + lista : '‚úÖ No hay gastos registrados hoy'}

üí° Puedes borrar el registro para tenerlo limpio.

--- Fin del resumen del d√≠a ---`;
    
    await navigator.clipboard.writeText(resumen);
    
    // Mostrar mensaje con la sugerencia de borrar
    btn.textContent = "‚úÖ ¬°Copiado!";
    setTimeout(() => {
      btn.textContent = originalText;
      btn.disabled = false;
    }, 2000);
    
    // Mostrar alerta con el mensaje solicitado
    alert(`‚úÖ Resumen del d√≠a copiado al portapapeles!\n\nüí° Puedes borrar el registro para tenerlo limpio.`);
    
    console.log("=== RESUMEN DEL D√çA GENERADO ===");
    console.log("Fecha:", fechaHoyStr);
    console.log("Gastos hoy:", conteo);
    console.log("Total hoy:", total);
    
  } catch (error) {
    console.error("Error al copiar resumen:", error);
    alert("‚ùå Error: " + error.message);
    
    const btn = document.getElementById("copiarResumenBtn");
    btn.textContent = "üìã Copiar resumen del D√çA";
    btn.disabled = false;
  }
});
</script>
</body>
</html>